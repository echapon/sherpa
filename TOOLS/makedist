#!/bin/bash

DISTDIR=`date +'%y-%m-%d'`

ECOPT=""

print_help() {
  echo "makedist version 1.0 " && echo && \
  echo "options: -f             include full time information in distribution name" && \
  echo "         -n <name>      write compressed distribution to <name>.tar.gz" && \
  echo "         -u             distribute uncompressed modules" && \
  echo "         --clean        execute 'make clean' before 'make dist'" && \
  echo "         --configure    configure before 'make dist' (enabled with '--total')" && \
  echo "         --total        rebuild 'Makefile.in's' and 'configure's' before 'make dist'" && \
  echo "         --copt         define option for 'configure'" && \
  echo "         --no-abort     ignore exit status of 'make'" && \
  echo "         --force        overwrite existing targets" && \
  echo "         -h             display this help and exit" && \
  echo
}

while getopts :hfun: OPT
do
  case $OPT in
  f) DISTDIR=$DISTDIR"_"`date +'%H-%M'` ;;
  u) COMP=FALSE ;;
  n) DISTDIR=$OPTARG ;;
  h) print_help && exit 0 ;;
  \?)
    shift `expr $OPTIND - 1`
    if [ "$1" = "--clean" ]; then ALLCLEAN=TRUE 
    elif [ "$1" = "--configure" ]; then CONFIGURE=TRUE 
    elif [ "$1" = "--hide-cvs" ]; then ECOPT=$ECOPT" --disable-cvsinclude" && CONFIGURE=TRUE
    elif [ "$1" = "--total" ]; then TOTAL=TRUE && CONFIGURE=TRUE
    elif [ "$1" = "--copt" ]; then 
      CONFIGURE=TRUE && ECOPT=$2" "$ECOPT && shift 1
    elif [ "$1" = "--no-abort" ]; then NOABORT=TRUE
    elif [ "$1" = "--force" ]; then FORCE=TRUE 
    else 
      echo -n "makedist: error: unrecognized option "
      if [ $OPTARG != "-" ]; then echo "'-$OPTARG'. try '--help'"
      else echo "'$1'. try '--help'"
      fi
      print_help && exit 1
    fi
    shift 1
    OPTIND=1
  esac
done

if test -d $DISTDIR ; then
  echo "makedist: error: temporary directory '$DISTDIR' exists"
  exit 1
fi
if test -f $DISTDIR.tar.gz && [ "$FORCE" != "TRUE" ] ; then
  echo "makedist: error: dist file '$DISTDIR.tar.gz' exists"
  echo "makedist: add '--force' to override"
  exit 2
fi

echo "*************************************"
echo "*  creating distribution of SHERPA  *"
echo "*************************************"
if [ "$TOTAL" = "TRUE" ]; then
  libtoolize --force
  aclocal
  automake -a
  autoconf
fi
if [ "$CONFIGURE" = "TRUE" ]; then 
  ./configure $ECOPT
fi
if [ "$ALLCLEAN" = "TRUE" ]; then 
  make clean 
fi
CONTINUE="r"
while [ "$CONTINUE" = "r" ]; do 
  CONTINUE=""
  if ! make dist ; then 
    echo "makedist: error: \"make dist\" in $I failed"
    if [ ! "$NOABORT" = "TRUE" ]; then
      until [ "$CONTINUE" = "y" ] || [ "$CONTINUE" = "n" ] || [ "$CONTINUE" = "r" ]; do
        if ! read -t 300 -n 1 -p "continue anyway (y/n/r/b) ? " CONTINUE ; then
	  CONTINUE="n"
        fi
        echo ""
        if [ "$CONTINUE" = "n" ]; then
          exit 1
        elif [ "$CONTINUE" = "b" ]; then
          bash 
          CONTINUE="r"
        fi
      done
    fi
  fi
done
mv SHERPA-MC-1.0.9.tar.gz $DISTDIR.tar.gz
echo -e "\nwrote distribution to '$DISTDIR".tar.gz"'\n"
exit 0

# mode:shell-script
# sh-indentation:2

